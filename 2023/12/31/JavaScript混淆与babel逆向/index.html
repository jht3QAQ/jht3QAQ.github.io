<!DOCTYPE html>
<html lang="zh-CN">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/70e16d9eb5a85bcc.jpg">
  
  <title>JavaScript混淆与babel逆向 | jht3の个人站</title>
  
  <meta name="author" content="jht3" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="AST, JavaScript, babel, obfuscator" />
  
  <meta name="description" content="babel怎么去混淆?都有哪些坑爹特性?">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaScript混淆与babel逆向">
<meta property="og:url" content="https://jht3qaq.github.io/2023/12/31/JavaScript%E6%B7%B7%E6%B7%86%E4%B8%8Ebabel%E9%80%86%E5%90%91/">
<meta property="og:site_name" content="jht3の个人站">
<meta property="og:description" content="babel怎么去混淆?都有哪些坑爹特性?">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jht3qaq.github.io/images/70e16d9eb5a85bcc.jpg">
<meta property="article:published_time" content="2023-12-31T16:56:05.000Z">
<meta property="article:modified_time" content="2024-04-27T06:06:15.463Z">
<meta property="article:author" content="jht3">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="AST">
<meta property="article:tag" content="babel">
<meta property="article:tag" content="obfuscator">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jht3qaq.github.io/images/70e16d9eb5a85bcc.jpg">
  
  <!-- 站点验证相关 -->
  
    
      <meta name="google-site-verification" content="MQWM3IPENI3ulBzfSFA3WAHS6PStE70SKrONrDx5E88" />
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
    <style media="all">
            :root{
                            --navbar_desktop: rgba(144,215,236,.9);
                            --navbar_mobile: rgba(144,215,236,.9);
                        }
    </style>


  <link rel="stylesheet" class="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
  <script src="/js/kr-dark.min.js"></script>
  


    <style>
                @media(min-width:768px) {
        body.custom-background {
            background-image: url('https://api.jht3.top/getWinImg.php');
        }
        }
        :root{
                    --kratos_topnav_position: relative;
            }
    </style>

  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/light.min.css" media="all"></script>
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
<meta name="generator" content="Hexo 7.2.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                        <li>
                                            
                                                        <a href="/">
                                                            
                                                                
                                                                        jht3の个人站
                                                        </a>
                                                        
                                        </li>
                                        
                                            
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">
                            jht3の个人站
                        </a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        
                <div id="kratos-blog-post">
                    <div class="container">
                        <div id="main" class="row">
                            

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://jht3qaq.github.io/2023/12/31/JavaScript%E6%B7%B7%E6%B7%86%E4%B8%8Ebabel%E9%80%86%E5%90%91/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">JavaScript混淆与babel逆向</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-12-31T16:56:05.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2024-01-01</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">jht3</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~21.59K
                        
                        字
                    </li>
                
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1714197975463"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
                <div class="kratos-post-inner-toc toc-div-class" >
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">1. 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babel%E7%89%B9%E6%80%A7"><span class="toc-text">2. babel特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">2.1. 解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaScript%E9%80%86%E5%90%91"><span class="toc-text">3. JavaScript逆向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BC%96%E7%A0%81"><span class="toc-text">3.1. 字符串编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E7%94%A8%E5%8F%98%E9%87%8F"><span class="toc-text">3.2. 无用变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#const%E5%8F%98%E9%87%8F"><span class="toc-text">3.3. const变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%BD%99%E9%80%BB%E8%BE%91%E5%88%A4%E6%96%AD"><span class="toc-text">3.4. 多余逻辑判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%BD%99%E7%9A%84BlockStatement%E5%9D%97"><span class="toc-text">3.5. 多余的BlockStatement块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B7%B7%E6%B7%86"><span class="toc-text">3.6. 表达式混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5%E6%95%B0%E7%BB%84%E4%B8%8B%E6%A0%87%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AE%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0"><span class="toc-text">3.7. 以数组下标方式访问成员函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0"><span class="toc-text">3.8. 替换执行函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96"><span class="toc-text">3.9. 控制流平坦化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%B7%B7%E6%B7%86"><span class="toc-text">3.10. 函数调用混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8switch%E7%9A%84%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96"><span class="toc-text">3.11. 使用switch的控制流平坦化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-text">4. 后记</span></a></li></ol>
                </div>
            
            <hr />
            <div itemprop="articleBody"><h2 id="前言">1. 前言</h2>
<p>babel是逆向js的一大利器，对于不了解使用babel逆向javascript的我推荐看以下这篇文章：<br>
<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/fIbPuNMs5FRADJE5MOZXgA">逆向进阶，利用 AST 技术还原 JavaScript 混淆代码</a></p>
<p>其中也有一些很有用的网站：<br>
<a target="_blank" rel="noopener" href="https://astexplorer.net/">AST explorer</a>：可以在线解析AST树，在分析代码的过程中很有帮助，使用时记得在网站顶部把编译器换成<code>@babel/parser</code>。<br>
<a target="_blank" rel="noopener" href="https://www.babeljs.cn/docs/babel-types">@babel/types文档</a>：查babel的node名称和属性基本上就靠他了。<br>
<a target="_blank" rel="noopener" href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md">Babel 插件手册</a>：介绍了如何使用babel进行AST转换。</p>
<p>但是在实际使用中，由于babel的特性/bug比较多，逆向过程中会有很多问题，所以才有了这么一篇踩坑文章。</p>
<h2 id="babel特性">2. babel特性</h2>
<p>由于在AST转换过程中直接给node赋值无法自动修改node中包含的引用，所以要在path上使用<code>replaceWith</code>函数进行替换node，但是这个<code>replaceWith</code>函数本身就有很多特性，所以会在使用的时候有很多意料之外的情况，具体来说他会：</p>
<ul>
<li>在<code>replaceWtih</code>后不会删去原来node包含的引用(references、referenced和referencePaths)</li>
<li><code>replaceWith</code>增加的新节点不一定会添加引用(没有仔细测试，貌似如果一个node经过两次clone他就无法在replaceWith时增加引用?)</li>
<li>同样<code>replaceWith</code>也不会更新<code>constantViolations</code></li>
</ul>
<p>同时traverse也会有一些神奇的特性，比如在使用<code>path.traverse</code>的时候，不会遍历到path节点，这就会导致有时候traverse结果和想象中的不一样。</p>
<p>总之我们在使用babel进行逆向去混淆的过程中一定要仔细处理node中包含的引用，否则ast中错误的reference会对后续的去混淆造成影响，无论是存在无效的reference（导致节点始终在被引用的状态，且遍历reference时node可能无效）还是缺少reference（在根据reference处理node时可能会造成某些node遗漏未被处理）。</p>
<h3 id="解决方案">2.1. 解决方案</h3>
<p>对于这种replaceWith无法很好的更新引用的情况，我们可以在replaceWith前后手动修复引用，但是对于<code>constantViolations</code>，我实在是不想处理了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fixReference</span>(<span class="params">path</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_fixReference</span>(<span class="params">identifierPath</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> binding = path.<span class="property">scope</span>.<span class="title function_">getBinding</span>(identifierPath.<span class="property">node</span>.<span class="property">name</span>);</span><br><span class="line">        <span class="keyword">if</span> (binding === <span class="literal">undefined</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (binding.<span class="property">referencePaths</span>.<span class="title function_">indexOf</span>(identifierPath) !== -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">        binding.<span class="property">referencePaths</span>.<span class="title function_">push</span>(identifierPath);</span><br><span class="line">        binding.<span class="property">references</span> = binding.<span class="property">referencePaths</span>.<span class="property">length</span>;</span><br><span class="line">        binding.<span class="property">referenced</span> = binding.<span class="property">references</span> !== <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//traverse不会遍历自己</span></span><br><span class="line">    <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">type</span> === <span class="string">&quot;Identifier&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">_fixReference</span>(path);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        path.<span class="title function_">traverse</span>(&#123;</span><br><span class="line">            <span class="title class_">Identifier</span>(identifierPath) &#123;</span><br><span class="line">                <span class="title function_">_fixReference</span>(identifierPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeReference</span>(<span class="params">path</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_removeReference</span>(<span class="params">identifierPath</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> binding = path.<span class="property">scope</span>.<span class="title function_">getBinding</span>(identifierPath.<span class="property">node</span>.<span class="property">name</span>);</span><br><span class="line">        <span class="keyword">if</span> (binding === <span class="literal">undefined</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> idx = binding.<span class="property">referencePaths</span>.<span class="title function_">indexOf</span>(identifierPath);</span><br><span class="line">        <span class="keyword">if</span> (idx &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            binding.<span class="property">referencePaths</span>.<span class="title function_">splice</span>(idx, <span class="number">1</span>);</span><br><span class="line">            binding.<span class="property">references</span> = binding.<span class="property">referencePaths</span>.<span class="property">length</span>;</span><br><span class="line">            binding.<span class="property">referenced</span> = binding.<span class="property">references</span> !== <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//traverse不会遍历自己</span></span><br><span class="line">    <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">type</span> === <span class="string">&quot;Identifier&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">_removeReference</span>(path);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        path.<span class="title function_">traverse</span>(&#123;</span><br><span class="line">            <span class="title class_">Identifier</span>(identifierPath) &#123;</span><br><span class="line">                <span class="title function_">_removeReference</span>(identifierPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">replaceWith</span>(<span class="params">path, node</span>) &#123;</span><br><span class="line">    <span class="title function_">removeReference</span>(path);</span><br><span class="line">    path.<span class="title function_">replaceWith</span>(node);</span><br><span class="line">    <span class="title function_">fixReference</span>(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="JavaScript逆向">3. JavaScript逆向</h2>
<h3 id="字符串编码">3.1. 字符串编码</h3>
<p>我们先来考虑一些简单的场景：字符串编码混淆</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//混淆前</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&#x27;\&quot; \\&quot;</span>);</span><br><span class="line"><span class="comment">//混淆后</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello\x20World!&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;\x27\x22\x20\x5c&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://astexplorer.net/#/gist/d50fb4dbdd53f36ab5a4099b7ec9e8b9/a513a53d2591276e60662e1aaaef581645a755ba">AST树</a>：</p>
<img src="/2023/12/31/JavaScript%E6%B7%B7%E6%B7%86%E4%B8%8Ebabel%E9%80%86%E5%90%91/%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BC%96%E7%A0%81%E6%B7%B7%E6%B7%86.png" class title="字符串编码混淆">
<p>在逆向的过程中可以使用以下Visitor反混淆：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stringDecodeVisitor = &#123;</span><br><span class="line">    <span class="title class_">StringLiteral</span>(path) &#123;</span><br><span class="line">        <span class="keyword">delete</span> path.<span class="property">node</span>.<span class="property">extra</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于根据babel文档，<a target="_blank" rel="noopener" href="https://www.babeljs.cn/docs/babel-types#stringliteral">StringLiteral</a>只有value属性是必须的有的，所以直接删掉extra属性就行了。</p>
<h3 id="无用变量">3.2. 无用变量</h3>
<p>在反混淆的过程中随着代码简化，会有很多变量不再被引用，此时我们可以通过如下Vistor去除：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> removeSymbolVisitor = &#123;</span><br><span class="line">    <span class="title class_">VariableDeclarator</span>(path) &#123;</span><br><span class="line">        <span class="keyword">const</span> binding = path.<span class="property">scope</span>.<span class="title function_">getBinding</span>(path.<span class="property">node</span>.<span class="property">id</span>.<span class="property">name</span>);</span><br><span class="line">        <span class="comment">// 如标识符被修改过，则不能进行删除动作。</span></span><br><span class="line">        <span class="keyword">if</span> (!binding || binding.<span class="property">constantViolations</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 未被引用</span></span><br><span class="line">        <span class="keyword">if</span> (!binding.<span class="property">referenced</span>) &#123;</span><br><span class="line">            path.<span class="title function_">remove</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>constantViolations</code>可能不太好理解，举个例子，以下两行代码（即a的赋值和a的自增）均会增加<code>a</code>的<code>constantViolations</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>; </span><br><span class="line">a++;</span><br></pre></td></tr></table></figure>
<p>目前来看还有留着这种变量的需要，因为有的时候变量值不重要但是赋值操作很重要，比如如下情况：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="built_in">eval</span>(b);</span><br></pre></td></tr></table></figure>
<p>这种情况下虽然a没有reference但是删掉a会导致<code>eval(b)</code>消失，从而导致代码逻辑错误。</p>
<h3 id="const变量">3.3. const变量</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//混淆前</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="comment">//混淆后</span></span><br><span class="line"><span class="keyword">const</span> a=<span class="number">1</span>,b=a;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a,b);</span><br></pre></td></tr></table></figure>
<p>其中只要找到type为const的<a target="_blank" rel="noopener" href="https://www.babeljs.cn/docs/babel-types#variabledeclaration">VariableDeclaration</a>并在其中找<code>init</code>类型为<code>Literal</code>或<code>Identifier</code>的常量，替换其中的引用即可。</p>
<p>Visitor如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inlineConstValueVisitor = &#123;</span><br><span class="line">    <span class="title class_">VariableDeclaration</span>(path) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">kind</span> !== <span class="string">&quot;const&quot;</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// declarations: Array&lt;VariableDeclarator&gt; (required)</span></span><br><span class="line">        path.<span class="title function_">get</span>(<span class="string">&quot;declarations&quot;</span>).<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">path</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">init</span> === <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">if</span> (!(types.<span class="title function_">isLiteral</span>(path.<span class="property">node</span>.<span class="property">init</span>) || path.<span class="property">node</span>.<span class="property">init</span>.<span class="property">type</span> === <span class="string">&quot;Identifier&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">            path.<span class="property">scope</span>.<span class="title function_">getBinding</span>(path.<span class="property">node</span>.<span class="property">id</span>.<span class="property">name</span>).<span class="property">referencePaths</span>.<span class="title function_">slice</span>().<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">_path</span>) &#123;</span><br><span class="line">                <span class="title function_">replaceWith</span>(_path, types.<span class="title function_">cloneDeepWithoutLoc</span>(path.<span class="property">node</span>.<span class="property">init</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="title function_">removeReference</span>(path);</span><br><span class="line">            path.<span class="title function_">remove</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多余逻辑判断">3.4. 多余逻辑判断</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//混淆前</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>);</span><br><span class="line"><span class="comment">//混淆后</span></span><br><span class="line"><span class="keyword">if</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="literal">false</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="literal">false</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">false</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<a target="_blank" rel="noopener" href="https://www.babeljs.cn/docs/babel-types#ifstatement">IfStatement</a>包含test、consequent、alternate三个node，alternate可以为null，我们可以根据test计算结果来替换分支逻辑。</p>
<p>而<a target="_blank" rel="noopener" href="https://www.babeljs.cn/docs/babel-types#whilestatement">WhileStatement</a>包含test和body，只有在test结果为false时才可以把整个While删去。</p>
<p>Visitor如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unreachablePathVisitor = &#123;</span><br><span class="line">    <span class="string">&quot;IfStatement|ConditionalExpression&quot;</span>(path) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; confident, value &#125; = path.<span class="title function_">get</span>(<span class="string">&quot;test&quot;</span>).evaluate();</span><br><span class="line">        <span class="keyword">if</span> (confident) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value) &#123;</span><br><span class="line">                <span class="title function_">replaceWith</span>(path, types.<span class="title function_">cloneDeepWithoutLoc</span>(path.<span class="property">node</span>.<span class="property">consequent</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">alternate</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="title function_">replaceWith</span>(path, types.<span class="title function_">cloneDeepWithoutLoc</span>(path.<span class="property">node</span>.<span class="property">alternate</span>));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="title function_">removeReference</span>(path);</span><br><span class="line">                    path.<span class="title function_">remove</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title class_">WhileStatement</span>(path) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; confident, value &#125; = path.<span class="title function_">get</span>(<span class="string">&quot;test&quot;</span>).evaluate();</span><br><span class="line">        <span class="keyword">if</span> (confident &amp;&amp; value === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="title function_">removeReference</span>(path);</span><br><span class="line">            path.<span class="title function_">remove</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多余的BlockStatement块">3.5. 多余的BlockStatement块</h3>
<p>有时候我们在替换node后有些BlockStatement块就显得多余了，比如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//化简前</span></span><br><span class="line"><span class="keyword">if</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//因为IfStatement的test恒为true，所以我们可以直接用IfStatement的consequent值替换IfStatement</span></span><br><span class="line"><span class="comment">//化简后</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时<a target="_blank" rel="noopener" href="https://astexplorer.net/#/gist/30890c10a021b25e758720f3d50b5d0e/a75b0e5d3fab79ef739213d8ef336a4c51e6d38d">AST</a>如图：</p>
<img src="/2023/12/31/JavaScript%E6%B7%B7%E6%B7%86%E4%B8%8Ebabel%E9%80%86%E5%90%91/%E5%A4%9A%E4%BD%99%E7%9A%84BlockStatement.png" class title="多余的BlockStatement">
<p>此时我们可以判断replaceWith的node是否为BlockStatement，如果是他的body数组长度是否为1，如果为1我们可以直接用他的<code>body[0]</code>去替换这个BlockStatement。</p>
<p>我们将上文的replaceWith改成如下形式即可达到replace的过程中自动化简BlockStatement的目的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">replaceWith</span>(<span class="params">path, node</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">tryUnwarpBlockStatement</span>(<span class="params">node</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.<span class="property">type</span> !== <span class="string">&quot;BlockStatement&quot;</span> || node.<span class="property">body</span>.<span class="property">length</span> !== <span class="number">1</span>) <span class="keyword">return</span> node;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> node.<span class="property">body</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">removeReference</span>(path);</span><br><span class="line">    path.<span class="title function_">replaceWith</span>(<span class="title function_">tryUnwarpBlockStatement</span>(node));</span><br><span class="line">    <span class="title function_">fixReference</span>(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="表达式混淆">3.6. 表达式混淆</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//混淆前</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="string">&quot;string&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">//混淆后</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="string">&quot;str&quot;</span>+<span class="string">&quot;ing&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="string">&quot;123&quot;</span>==<span class="string">&quot;456&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> c = ![];</span><br><span class="line"><span class="keyword">const</span> d = !![];</span><br></pre></td></tr></table></figure>
<p>对此我们可以尝试对表达式求值，如果evaluate结果为confident我们就可以用value做替换：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> evalVisiotr = &#123;</span><br><span class="line">    <span class="string">&quot;UnaryExpression|BinaryExpression|CallExpression|ConditionalExpression&quot;</span>(path) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; confident, value &#125; = path.evaluate();</span><br><span class="line">        <span class="keyword">if</span> (confident) &#123;</span><br><span class="line">            <span class="title function_">removeReference</span>(path);</span><br><span class="line">            path.<span class="title function_">replaceInline</span>(types.<span class="title function_">valueToNode</span>(value));</span><br><span class="line">            path.<span class="title function_">skip</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="以数组下标方式访问成员函数">3.7. 以数组下标方式访问成员函数</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//混淆前</span><br><span class="line">console.log(&#x27;Hello World!&#x27;);</span><br><span class="line">//混淆后</span><br><span class="line">console[&#x27;log&#x27;](&#x27;Hello World!&#x27;);</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://astexplorer.net/#/gist/d59074c774f6aa91b0f34c66f9f60664/19e4be20aad8907ab77f4fca3b36be2ae521846a">AST树</a>：</p>
<img src="/2023/12/31/JavaScript%E6%B7%B7%E6%B7%86%E4%B8%8Ebabel%E9%80%86%E5%90%91/%E6%95%B0%E7%BB%84%E4%B8%8B%E6%A0%87%E8%AE%BF%E9%97%AE%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0.png" class title="数组下标访问成员函数">
<p>其中访问成员函数的node为<a target="_blank" rel="noopener" href="https://www.babeljs.cn/docs/babel-types#memberexpression">MemberExpression</a>，其中computed变量代表是否以数组下标方式访问，property为访问的函数名称，这里将computed设置为<code>false</code>并将property设置为字符串的值来还原成员函数的访问。</p>
<p>反混淆用的Visitor代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> callFunctionReverseVisitor = &#123;</span><br><span class="line">    <span class="title class_">CallExpression</span>(path) &#123;</span><br><span class="line">        <span class="comment">//callee可以为Expression | Super | V8IntrinsicIdentifier，这里只要MemberExpression</span></span><br><span class="line">        <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">callee</span>.<span class="property">type</span> === <span class="string">&quot;MemberExpression&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> callee = path.<span class="property">node</span>.<span class="property">callee</span>;</span><br><span class="line">            <span class="keyword">if</span> (callee.<span class="property">computed</span> === <span class="literal">true</span> &amp;&amp; callee.<span class="property">property</span>.<span class="property">type</span> === <span class="string">&quot;StringLiteral&quot;</span>) &#123;</span><br><span class="line">                callee.<span class="property">computed</span> = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">const</span> idxPath = path.<span class="title function_">get</span>(<span class="string">&quot;callee.property&quot;</span>)</span><br><span class="line">                <span class="title function_">replaceWith</span>(idxPath,types.<span class="title function_">identifier</span>(callee.<span class="property">property</span>.<span class="property">value</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="替换执行函数">3.8. 替换执行函数</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//混淆后</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="title function_">func</span>(args);</span><br></pre></td></tr></table></figure>
<p>此时func里面可能包含一些反反混淆代码，可能是debuger检测，也可能是代码格式化检查等。如果我们希望自己定义func并执行计算结果就可以用如下Visitor</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">functionEvalVisitor</span>(<span class="params">funcName, func</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="title class_">CallExpression</span>(path) &#123;</span><br><span class="line">            <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">callee</span>.<span class="property">type</span> === <span class="string">&quot;Identifier&quot;</span> &amp;&amp; path.<span class="property">node</span>.<span class="property">callee</span>.<span class="property">name</span> === funcName) &#123;</span><br><span class="line">                <span class="title function_">removeReference</span>(path);</span><br><span class="line">                <span class="keyword">const</span> evaluate = path.<span class="title function_">get</span>(<span class="string">&quot;arguments&quot;</span>).<span class="title function_">map</span>(<span class="function">(<span class="params">path</span>) =&gt;</span> &#123; <span class="keyword">return</span> path.evaluate() &#125;);</span><br><span class="line">                <span class="keyword">if</span> (evaluate.<span class="title function_">every</span>(<span class="function">(<span class="params"><span class="built_in">eval</span></span>) =&gt;</span> &#123; <span class="keyword">return</span> <span class="built_in">eval</span>.<span class="property">confident</span> &#125;)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> args = evaluate.<span class="title function_">map</span>(<span class="function">(<span class="params"><span class="built_in">eval</span></span>) =&gt;</span> &#123; <span class="keyword">return</span> <span class="built_in">eval</span>.<span class="property">value</span> &#125;);</span><br><span class="line">                    <span class="keyword">const</span> value = <span class="title function_">func</span>(...args);</span><br><span class="line">                    <span class="keyword">switch</span> (<span class="keyword">typeof</span> value) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&quot;string&quot;</span>:</span><br><span class="line">                            path.<span class="title function_">replaceInline</span>(types.<span class="title function_">stringLiteral</span>(value));</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&quot;number&quot;</span>:</span><br><span class="line">                            path.<span class="title function_">replaceInline</span>(types.<span class="title function_">numericLiteral</span>(value));</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&quot;boolean&quot;</span>:</span><br><span class="line">                            path.<span class="title function_">replaceInline</span>(types.<span class="title function_">booleanLiteral</span>(value));</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&quot;undefined&quot;</span>:</span><br><span class="line">                            path.<span class="title function_">replaceInline</span>(types.<span class="title function_">identifier</span>(<span class="string">&#x27;undefined&#x27;</span>));</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="attr">default</span>:</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Unsupported return type&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="控制流平坦化">3.9. 控制流平坦化</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//混淆前</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getStr</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;aaaaaaaa&quot;</span>+<span class="title function_">func</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//混淆后</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getStr</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = &#123;</span><br><span class="line">        <span class="string">&#x27;XxitO&#x27;</span>: <span class="keyword">function</span> (<span class="params">b, c</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> b + c;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;dXnor&#x27;</span>: <span class="string">&#x27;aaaaaaaa&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;TvVRl&#x27;</span>: <span class="keyword">function</span> (<span class="params">b</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">b</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> a[<span class="string">&#x27;XxitO&#x27;</span>](a[<span class="string">&#x27;dXnor&#x27;</span>], a[<span class="string">&#x27;TvVRl&#x27;</span>](func));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://astexplorer.net/#/gist/d39a3f16d964bc527429e857c621bc6a/c9a4074dc480a5d4569e8a44f0eac668d99c8791">AST树</a>：</p>
<img src="/2023/12/31/JavaScript%E6%B7%B7%E6%B7%86%E4%B8%8Ebabel%E9%80%86%E5%90%91/%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96.png" class title="控制流平坦化">
<p>我们可以根据<code>MemberExpression</code>去找他引用的对象，然后去对象的<code>init.properties</code>找字典对应的值，然后把这个值给替换过来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> removeMemberExpressionVisitor = &#123;</span><br><span class="line">    <span class="title class_">MemberExpression</span>(path) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">property</span>.<span class="property">type</span> == <span class="string">&#x27;StringLiteral&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> binding = path.<span class="property">scope</span>.<span class="title function_">getBinding</span>(path.<span class="property">node</span>.<span class="property">object</span>.<span class="property">name</span>)</span><br><span class="line">            <span class="keyword">if</span> (binding !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> objPath = binding.<span class="property">path</span></span><br><span class="line">                <span class="keyword">if</span> (objPath.<span class="property">node</span>.<span class="property">init</span> !== <span class="literal">undefined</span> &amp;&amp; objPath.<span class="property">node</span>.<span class="property">init</span>.<span class="property">type</span> === <span class="string">&#x27;ObjectExpression&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> objPropertiesPath = objPath.<span class="title function_">get</span>(<span class="string">&quot;init.properties&quot;</span>)</span><br><span class="line">                    <span class="keyword">const</span> propertyPath = objPropertiesPath.<span class="title function_">find</span>(<span class="function">(<span class="params">_path</span>) =&gt;</span> &#123; <span class="keyword">return</span> _path.<span class="property">node</span>.<span class="property">type</span> === <span class="string">&#x27;ObjectProperty&#x27;</span> &amp;&amp; _path.<span class="property">node</span>.<span class="property">key</span>.<span class="property">type</span> === <span class="string">&#x27;StringLiteral&#x27;</span> &amp;&amp; _path.<span class="property">node</span>.<span class="property">key</span>.<span class="property">value</span> === path.<span class="property">node</span>.<span class="property">property</span>.<span class="property">value</span> &#125;)</span><br><span class="line">                    <span class="keyword">if</span> (propertyPath === <span class="literal">undefined</span>) <span class="keyword">return</span>;</span><br><span class="line">                    <span class="keyword">const</span> node = propertyPath.<span class="property">node</span>;</span><br><span class="line">                    <span class="keyword">const</span> value = node.<span class="property">value</span>;</span><br><span class="line">                    <span class="comment">// 复制Node需要深拷贝</span></span><br><span class="line">                    <span class="keyword">if</span> (types.<span class="title function_">isLiteral</span>(value)) &#123;</span><br><span class="line">                        <span class="comment">//Literal不包含引用</span></span><br><span class="line">                        <span class="title function_">replaceWith</span>(path, types.<span class="title function_">cloneDeepWithoutLoc</span>(node.<span class="property">value</span>))</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value.<span class="property">type</span> === <span class="string">&#x27;FunctionExpression&#x27;</span>) &#123;</span><br><span class="line">                        <span class="comment">//仅处理没有引用的FunctionExpression</span></span><br><span class="line">                        <span class="keyword">if</span> (value.<span class="property">id</span> === <span class="literal">null</span> &amp;&amp; value.<span class="property">generator</span> === <span class="literal">false</span> &amp;&amp; value.<span class="property">async</span> === <span class="literal">false</span> &amp;&amp; <span class="title function_">hasSingleStatement</span>(value) &amp;&amp; <span class="title function_">isRecursionFunction</span>(propertyPath.<span class="title function_">get</span>(<span class="string">&#x27;value&#x27;</span>)) === <span class="literal">false</span>) &#123;</span><br><span class="line">                            <span class="title function_">replaceWith</span>(path, types.<span class="title function_">cloneDeepWithoutLoc</span>(node.<span class="property">value</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行后效果如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getStr</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = &#123;</span><br><span class="line">    <span class="string">&quot;XxitO&quot;</span>: <span class="keyword">function</span> (<span class="params">b, c</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> b + c;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;dXnor&quot;</span>: <span class="string">&quot;aaaaaaaa&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TvVRl&quot;</span>: <span class="keyword">function</span> (<span class="params">b</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">b</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">b, c</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> b + c;</span><br><span class="line">  &#125;(<span class="string">&quot;aaaaaaaa&quot;</span>, <span class="keyword">function</span> (<span class="params">b</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">b</span>();</span><br><span class="line">  &#125;(func));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先不得不承认它更丑了，但你就说控制流平坦化解没解决吧(大雾)，上面的<code>var a</code>可以用<code>removeSymbolVisitor</code>去除，而下面的<code>FunctionExpression</code>我们后续再处理。</p>
<h3 id="函数调用混淆">3.10. 函数调用混淆</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//混淆前</span></span><br><span class="line"><span class="title function_">func</span>(<span class="number">0x400</span> - <span class="number">233</span>, <span class="number">0x200</span>);</span><br><span class="line"><span class="title function_">func</span>(<span class="number">123</span>, <span class="number">456</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> - <span class="number">2</span> - <span class="number">3</span>, [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> - <span class="number">2</span> - <span class="number">999</span>, []);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span> - <span class="number">4</span> - <span class="number">3</span>, []);</span><br><span class="line"><span class="comment">//混淆后</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">a</span>(<span class="params">a, b, c, d, e, f</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">func</span>(d - <span class="number">233</span>, b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">a</span>(<span class="number">0x100</span>, <span class="number">0x200</span>, <span class="number">0x300</span>, <span class="number">0x400</span>, <span class="number">0x500</span>, <span class="number">0x600</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">func</span>(a, b);</span><br><span class="line">&#125;)(<span class="number">123</span>, <span class="number">456</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params">a, b, c = <span class="number">3</span>, ...d</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(a - b - c, d);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">b</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="literal">undefined</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>);</span><br><span class="line"><span class="title function_">b</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">999</span>);</span><br><span class="line"><span class="title function_">b</span>(<span class="number">3</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>这两种情况我们分开考虑，对于<code>FunctionDeclaration</code>我们只要将函数<code>a</code>给内联即可，随后他会变成第二种<code>FunctionExpression</code>的状态，首先我们要确定我们可以inline的代码，对于复杂的函数我们不动：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hasSingleStatement</span>(<span class="params">funcNode</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcNode.<span class="property">body</span>.<span class="property">type</span> === <span class="string">&#x27;BlockStatement&#x27;</span> &amp;&amp; funcNode.<span class="property">body</span>.<span class="property">body</span>.<span class="property">length</span> === <span class="number">1</span> &amp;&amp; funcNode.<span class="property">body</span>.<span class="property">body</span>[<span class="number">0</span>].<span class="property">type</span> === <span class="string">&quot;ReturnStatement&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个代码会判断一个函数是否只有一个return代码块，只有满足条件才会返回true。</p>
<p>其次这个函数还不能递归，递归内联的话就寄了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isRecursionFunction</span>(<span class="params">funcPath</span>) &#123;</span><br><span class="line">    <span class="comment">// 他如果还能通过别的方式递归那我也没法了</span></span><br><span class="line">    <span class="keyword">if</span> (funcPath.<span class="property">node</span>.<span class="property">id</span> === <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> ret = <span class="literal">false</span>;</span><br><span class="line">    funcPath.<span class="title function_">traverse</span>(&#123;</span><br><span class="line">        <span class="title function_">enter</span>(<span class="params">path</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (funcPath.<span class="property">parentPath</span>.<span class="property">scope</span>.<span class="property">bindings</span>[funcPath.<span class="property">node</span>.<span class="property">id</span>.<span class="property">name</span>].<span class="property">referencePaths</span>.<span class="title function_">some</span>(<span class="keyword">function</span> (<span class="params">refPath</span>) &#123; <span class="keyword">return</span> refPath.<span class="property">node</span> === path.<span class="property">node</span>; &#125;)) &#123;</span><br><span class="line">                ret = <span class="literal">true</span>;</span><br><span class="line">                path.<span class="title function_">stop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们遍历<code>FunctionDeclaration</code>，将所有满足调教的函数从<code>FunctionDeclaration</code>内联成<code>FunctionExpression</code>，这个过程要仔细处理变量引用，相当的麻烦：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">inlineNamedFunction</span>(<span class="params">path</span>) &#123;</span><br><span class="line">    <span class="comment">// 没考虑通过arguments访问参数的情况</span></span><br><span class="line">    <span class="keyword">const</span> node = path.<span class="property">node</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">hasSingleStatement</span>(node)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">generator</span> || node.<span class="property">async</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isRecursionFunction</span>(path)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">id</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> name = node.<span class="property">id</span>.<span class="property">name</span>;</span><br><span class="line">        <span class="keyword">const</span> binding = path.<span class="property">scope</span>.<span class="property">parent</span>.<span class="property">bindings</span>[name];</span><br><span class="line">        _referencePaths = []</span><br><span class="line">        binding.<span class="property">referencePaths</span>.<span class="title function_">slice</span>().<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">nodePath</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nodePath.<span class="property">parent</span>.<span class="property">type</span> === <span class="string">&quot;CallExpression&quot;</span>) &#123;</span><br><span class="line">                _node = types.<span class="title function_">cloneDeepWithoutLoc</span>(node);</span><br><span class="line">                nodePath.<span class="title function_">replaceWith</span>(types.<span class="title function_">functionExpression</span>(<span class="literal">null</span>, _node.<span class="property">params</span>, _node.<span class="property">body</span>, _node.<span class="property">generator</span>, _node.<span class="property">async</span>));</span><br><span class="line">                <span class="title function_">inlineFunction</span>(nodePath, nodePath.<span class="property">parentPath</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                _referencePaths.<span class="title function_">push</span>(nodePath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        binding.<span class="property">referencePaths</span> = _referencePaths;</span><br><span class="line">        binding.<span class="property">references</span> = _referencePaths.<span class="property">length</span>;</span><br><span class="line">        binding.<span class="property">referenced</span> = binding.<span class="property">references</span> !== <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> inlineFunctionDeclarationVisitor = &#123;</span><br><span class="line">    <span class="title class_">FunctionDeclaration</span>(path) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">id</span>) <span class="title function_">inlineNamedFunction</span>(path);</span><br><span class="line">        <span class="keyword">if</span> (!(path.<span class="property">node</span>.<span class="property">id</span> &amp;&amp; path.<span class="property">scope</span>.<span class="property">parent</span>.<span class="property">bindings</span>[path.<span class="property">node</span>.<span class="property">id</span>.<span class="property">name</span>].<span class="property">referenced</span>)) &#123;</span><br><span class="line">            <span class="title function_">removeReference</span>(path);</span><br><span class="line">            path.<span class="title function_">remove</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时候我们再来处理<code>FunctionExpression</code>，我们遍历所有<code>CallExpression</code>，检查调用的目标是否为<code>FunctionExpression</code>，这个<code>FunctionExpression</code>也有<code>id</code>属性，因此<code>FunctionDeclaration</code>该做的检查他是一点都不能少啊：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inlineFunctionExpressionVisitor = &#123;</span><br><span class="line">    <span class="title class_">CallExpression</span>(path) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">callee</span>.<span class="property">type</span> === <span class="string">&#x27;FunctionExpression&#x27;</span> &amp;&amp; <span class="title function_">hasSingleStatement</span>(path.<span class="property">node</span>.<span class="property">callee</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">callee</span>.<span class="property">id</span> !== <span class="literal">null</span>) <span class="title function_">inlineNamedFunction</span>(path.<span class="title function_">get</span>(<span class="string">&quot;callee&quot;</span>));</span><br><span class="line">            <span class="title function_">inlineFunction</span>(path.<span class="title function_">get</span>(<span class="string">&quot;callee&quot;</span>), path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们实现具体的内联功能，其中<code>functionExpression</code>的<code>params</code>真的是多种多样，而引用一处理不好也会寄，总之直接看代码吧：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">inlineFunction</span>(<span class="params">func, call</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> arg = call.<span class="property">node</span>.<span class="property">arguments</span>;</span><br><span class="line">    <span class="comment">// functionExpression</span></span><br><span class="line">    <span class="comment">// params: Array&lt;Identifier | Pattern | RestElement&gt; (required)</span></span><br><span class="line">    func.<span class="property">node</span>.<span class="property">params</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">param, idx</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> paramName;</span><br><span class="line">        <span class="keyword">if</span> (types.<span class="title function_">isIdentifier</span>(param)) &#123;</span><br><span class="line">            paramName = param.<span class="property">name</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.<span class="title function_">isPattern</span>(param)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (param.<span class="property">left</span>.<span class="property">type</span> !== <span class="string">&quot;Identifier&quot;</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;unknown node type&#x27;</span>);</span><br><span class="line">            paramName = param.<span class="property">left</span>.<span class="property">name</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.<span class="title function_">isRestElement</span>(param)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (param.<span class="property">argument</span>.<span class="property">type</span> !== <span class="string">&quot;Identifier&quot;</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;unknown node type&#x27;</span>);</span><br><span class="line">            paramName = param.<span class="property">argument</span>.<span class="property">name</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        func.<span class="property">scope</span>.<span class="property">bindings</span>[paramName].<span class="property">referencePaths</span>.<span class="title function_">slice</span>().<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">path</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (path.<span class="property">node</span>.<span class="property">type</span> === <span class="string">&quot;Identifier&quot;</span>) &#123;</span><br><span class="line">                <span class="comment">// node未修改完 replace的时候没有正确的scope 因此需要在最后修复reference</span></span><br><span class="line">                <span class="keyword">if</span> (types.<span class="title function_">isIdentifier</span>(param)) &#123;</span><br><span class="line">                    <span class="title function_">removeReference</span>(path);</span><br><span class="line">                    path.<span class="title function_">replaceWith</span>((arg[idx] === <span class="literal">undefined</span> ? types.<span class="title function_">identifier</span>(<span class="string">&quot;undefined&quot;</span>) : types.<span class="title function_">cloneDeepWithoutLoc</span>(arg[idx])));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.<span class="title function_">isPattern</span>(param)) &#123;</span><br><span class="line">                    <span class="title function_">removeReference</span>(path);</span><br><span class="line">                    path.<span class="title function_">replaceWith</span>(types.<span class="title function_">cloneDeepWithoutLoc</span>((arg[idx] === <span class="literal">undefined</span> || arg[idx].<span class="property">value</span> === <span class="literal">undefined</span>) ? param.<span class="property">right</span> : arg[idx]));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.<span class="title function_">isRestElement</span>(param)) &#123;</span><br><span class="line">                    <span class="title function_">removeReference</span>(path);</span><br><span class="line">                    path.<span class="title function_">replaceWith</span>(types.<span class="title function_">arrayExpression</span>(arg.<span class="title function_">slice</span>(idx)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;unknown node type&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">replaceWith</span>(call, types.<span class="title function_">cloneDeepWithoutLoc</span>(func.<span class="property">node</span>.<span class="property">body</span>.<span class="property">body</span>[<span class="number">0</span>].<span class="property">argument</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用switch的控制流平坦化">3.11. 使用switch的控制流平坦化</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//混淆前</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;3&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;4&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;5&quot;</span>);</span><br><span class="line"><span class="comment">//混淆后</span></span><br><span class="line"><span class="keyword">var</span> aaaaaa = [<span class="string">&quot;2&quot;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;5&quot;</span>];</span><br><span class="line"><span class="keyword">var</span> bbbbbb = <span class="number">0x0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (aaaaaa[bbbbbb++]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;0&quot;</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;2&quot;</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;3&quot;</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;4&quot;</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;5&quot;</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里我们找到控制执行流程的数组，然后按照数组顺序还原代码即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> switchControlsFlowFlatteningVisitor = &#123;</span><br><span class="line">    <span class="title class_">WhileStatement</span>(path) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; <span class="attr">confident</span>: whileConfident, <span class="attr">value</span>: whileValue &#125; = path.<span class="title function_">get</span>(<span class="string">&quot;test&quot;</span>).evaluate();</span><br><span class="line">        <span class="keyword">if</span> (!(whileConfident === <span class="literal">true</span> &amp;&amp; whileValue === <span class="literal">true</span>)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(path.<span class="property">node</span>.<span class="property">body</span>.<span class="property">type</span> === <span class="string">&quot;BlockStatement&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> whileBodyNode = path.<span class="property">node</span>.<span class="property">body</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(whileBodyNode.<span class="property">body</span>.<span class="property">length</span> === <span class="number">2</span> &amp;&amp; whileBodyNode.<span class="property">body</span>[<span class="number">0</span>].<span class="property">type</span> === <span class="string">&quot;SwitchStatement&quot;</span> &amp;&amp; whileBodyNode.<span class="property">body</span>[<span class="number">1</span>].<span class="property">type</span> === <span class="string">&quot;BreakStatement&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> switchBodyNode = whileBodyNode.<span class="property">body</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (!(switchBodyNode.<span class="property">discriminant</span>.<span class="property">type</span> === <span class="string">&quot;MemberExpression&quot;</span> &amp;&amp; switchBodyNode.<span class="property">discriminant</span>.<span class="property">object</span>.<span class="property">type</span> === <span class="string">&quot;Identifier&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> listBinding = path.<span class="property">scope</span>.<span class="title function_">getBinding</span>(switchBodyNode.<span class="property">discriminant</span>.<span class="property">object</span>.<span class="property">name</span>)</span><br><span class="line">        <span class="keyword">if</span> (listBinding === <span class="literal">undefined</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(listBinding.<span class="property">path</span>.<span class="property">node</span>.<span class="property">type</span> === <span class="string">&quot;VariableDeclarator&quot;</span> &amp;&amp; listBinding.<span class="property">path</span>.<span class="property">node</span>.<span class="property">init</span> !== <span class="literal">null</span>)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> &#123; <span class="attr">confident</span>: listConfident, <span class="attr">value</span>: listValue &#125; = listBinding.<span class="property">path</span>.<span class="title function_">get</span>(<span class="string">&quot;init&quot;</span>).evaluate();</span><br><span class="line">        <span class="keyword">if</span> (!(listConfident === <span class="literal">true</span> &amp;&amp; <span class="title class_">Array</span>.<span class="title function_">isArray</span>(listValue))) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> consequent = <span class="title class_">Object</span>.<span class="title function_">fromEntries</span>(switchBodyNode.<span class="property">cases</span>.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> [x.<span class="property">test</span>.<span class="property">value</span>, x.<span class="property">consequent</span>]));</span><br><span class="line">        newCode = listValue.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> consequent[x]);</span><br><span class="line">        <span class="keyword">if</span> (newCode.<span class="title function_">some</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> x === <span class="literal">undefined</span>)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (newCode.<span class="title function_">some</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> x.<span class="title function_">at</span>(-<span class="number">1</span>).<span class="property">type</span> !== <span class="string">&quot;ContinueStatement&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line">        newCode = newCode.<span class="title function_">map</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> x.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>));</span><br><span class="line">        newCode = newCode.<span class="title function_">flat</span>();</span><br><span class="line">        newCode = newCode.<span class="title function_">map</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> types.<span class="title function_">cloneDeepWithoutLoc</span>(x));</span><br><span class="line">        newCodeStatement = types.<span class="title function_">blockStatement</span>(newCode);</span><br><span class="line">        <span class="title function_">replaceWith</span>(path, newCodeStatement);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="后记">4. 后记</h2>
<p>文章里出现的visitor可以在<a target="_blank" rel="noopener" href="https://gist.github.com/jht3QAQ/260ed36802659209b1c27a411c692833">visitor.js</a>中找到，代码未经过严格测试，可能包含一些bug(至少已知不会处理path的constantViolations值，并且在内联函数的过程中不会处理通过arguements访问的参数)，但是日常使用应该问题不大，总之babel很强大，但是bug少点就好了(悲)。</p>
</div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/AST/" rel="tag">AST</a>, <a class="tag-none-link" href="/tags/JavaScript/" rel="tag">JavaScript</a>, <a class="tag-none-link" href="/tags/babel/" rel="tag">babel</a>, <a class="tag-none-link" href="/tags/obfuscator/" rel="tag">obfuscator</a>
                </div>
                <div class="pull-date">
                    <time datetime="2024-04-27T06:06:15.463Z" itemprop="dateModified">最后编辑：2024-04-27</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" 红米Note 12T Pro使用体验" href="/2023/12/18/红米Note-12T-Pro使用体验/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" XYCTF2024 Writeup" href="/2024/04/26/XYCTF2024-Writeup/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
        <link rel="stylesheet" href="/vendors/gitalk@1.7.2/dist/gitalk.css"></script>
<div id="gitalk-container" class="post-comments lazy-load" style="padding-left:2rem; padding-right:2rem;"></div>
<script>
    var load_comm = () => {
        const init = () => {
            console.log('Gitalk loading...');
            const gitalk = new Gitalk(Object.assign({
                id: '65f26b529d88db8dd977589f1b7fdff8',
                path: '/2023/12/31/JavaScript%E6%B7%B7%E6%B7%86%E4%B8%8Ebabel%E9%80%86%E5%90%91/'
            }, JSON.parse('{"clientID":"263909d74813a540cbd5","clientSecret":"2281b95d2a4d3a7d298e387e940f9388e01883e5","repo":"jht3QAQ.github.io","owner":"jht3QAQ","admin":["jht3QAQ"],"distractionFreeMode":false}')));

            gitalk.render('gitalk-container');
        }
        if (typeof Gitalk === 'undefined') {
            const src = '/vendors/gitalk@1.7.2/dist/gitalk.min.js';
            $.getScript(src, init);
        } else {
            init();
        }
    };
</script>
<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://github.com/gitalk/gitalk">comments powered by Gitalk.</a></noscript>
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/70e16d9eb5a85bcc.jpg" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                3
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                0
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                10
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                    <aside id="krw-toc" class="widget widget-kratos-toc clearfix toc-div-class" >
    <div class="photo-background"></div>
    <h4 class="widget-title no-after">
        <i class="fa fa-compass"></i>
        文章目录
        <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span>
    </h4>
    <div class="textwidget">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">1. 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babel%E7%89%B9%E6%80%A7"><span class="toc-text">2. babel特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">2.1. 解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaScript%E9%80%86%E5%90%91"><span class="toc-text">3. JavaScript逆向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BC%96%E7%A0%81"><span class="toc-text">3.1. 字符串编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E7%94%A8%E5%8F%98%E9%87%8F"><span class="toc-text">3.2. 无用变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#const%E5%8F%98%E9%87%8F"><span class="toc-text">3.3. const变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%BD%99%E9%80%BB%E8%BE%91%E5%88%A4%E6%96%AD"><span class="toc-text">3.4. 多余逻辑判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%BD%99%E7%9A%84BlockStatement%E5%9D%97"><span class="toc-text">3.5. 多余的BlockStatement块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B7%B7%E6%B7%86"><span class="toc-text">3.6. 表达式混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5%E6%95%B0%E7%BB%84%E4%B8%8B%E6%A0%87%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AE%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0"><span class="toc-text">3.7. 以数组下标方式访问成员函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0"><span class="toc-text">3.8. 替换执行函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96"><span class="toc-text">3.9. 控制流平坦化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%B7%B7%E6%B7%86"><span class="toc-text">3.10. 函数调用混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8switch%E7%9A%84%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96"><span class="toc-text">3.11. 使用switch的控制流平坦化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-text">4. 后记</span></a></li></ol>
    </div>
</aside>
                
                

            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/AST/" style="font-size: 0.6em;">AST</a> <a href="/tags/CTF/" style="font-size: 0.6em;">CTF</a> <a href="/tags/JavaScript/" style="font-size: 0.6em;">JavaScript</a> <a href="/tags/QAuxiliary/" style="font-size: 0.6em;">QAuxiliary</a> <a href="/tags/Redmi-Note12T-Pro/" style="font-size: 0.6em;">Redmi Note12T Pro</a> <a href="/tags/babel/" style="font-size: 0.6em;">babel</a> <a href="/tags/obfuscator/" style="font-size: 0.6em;">obfuscator</a> <a href="/tags/root/" style="font-size: 0.6em;">root</a> <a href="/tags/%E5%93%94%E5%93%A9%E6%BC%AB%E6%B8%B8/" style="font-size: 0.6em;">哔哩漫游</a> <a href="/tags/%E5%B0%8F%E7%B1%B3/" style="font-size: 0.6em;">小米</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2024/04/26/XYCTF2024-Writeup/"><i class="fa  fa-book"></i> XYCTF2024 Writeup</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/12/31/JavaScript%E6%B7%B7%E6%B7%86%E4%B8%8Ebabel%E9%80%86%E5%90%91/"><i class="fa  fa-book"></i> JavaScript混淆与babel逆向</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/12/18/%E7%BA%A2%E7%B1%B3Note-12T-Pro%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/"><i class="fa  fa-book"></i> 红米Note 12T Pro使用体验</a>
            
          
        
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <!-- Keep for compatibility -->
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <!-- New links -->
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2024 jht3の个人站 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by jht3.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            <li><a href="https://icp.gov.moe/?keyword=20240011" rel="external nofollow" target="_blank">萌ICP备20240011号</a></li>
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
                    <div class="box theme-box" id="snow-switch">
                        <span class="fa fa-snowflake-o"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>

    <div>
        <canvas id="snow"></canvas>
        <script async src="/js/snow.min.js"></script>
    </div>


    <script async src="/js/candy.min.js"></script>




    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>